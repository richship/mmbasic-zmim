' ZMIM a Z-Machine Interpreter for the Colour Maximite
' Copyright (c) 2019 Thomas Hugo Williams

Function fmt_mnemonic$(m$)
  fmt_mnemonic$ = rpad$(m$, 13)
End Function

Function fmt_operand$(i)
  Local a$, x
  x = op_value(i)
  If op_type(i) <> OT_VARIABLE Then
    fmt_operand$ = "#" + lpad$(Hex$(x), 2, "0")
    Exit Function
  EndIf
  If x = 0 Then
    a$ = "(SP)+"
  ElseIf x < &h10 Then
    a$ = "L" + lpad$(Hex$(x - 1), 2, "0")
  Else
    a$ = "G" + lpad$(Hex$(x - &h10), 2, "0")
  EndIf
  fmt_operand$ = a$
End Function

Function fmt_store$(st)
  Local a$
  If st = 0 Then
    a$ = "-(SP)"
  ElseIf st < &h10 Then
    a$ = "L" + lpad$(Hex$(st - 1), 2, "0")
  Else
    a$ = "G" + lpad$(Hex$(st - &h10), 2, "0")
  EndIf
  fmt_store$ = a$
End Function

Function fmt_branch$(br)
  If br And BIT_15 Then Print " [TRUE] "; Else Print " [FALSE] ";
  Print Hex$(br And BTM_15_BITS);
End Function

Sub dmp_call(m$, st, br)
  Local i

  Print fmt_mnemonic$(m$); Hex$(2 * op_value(0)); " (";
  For i = 1 To op_num - 1
    If i > 1 Then Print ", ";
    Print fmt_operand$(i);
  Next i
  Print ")";
  If st > -1 Then Print " -> "; fmt_store$(st);
  If br > 0 Then Error
  Print
End Sub

Sub dmp_op(m$, st, br)
  Local i

  If m$ = "CALL" Then dmp_call(m$, st, br) : Exit Sub : EndIf

  Print fmt_mnemonic$(m$);
  For i = 0 To op_num - 1
    If i > 0 Then Print ", ";
    Print fmt_operand$(i);
  Next i
  If st > -1 Then Print " -> "; fmt_store$(st);
  If br > 0 Then Print fmt_branch$(br);
  Print
End Sub
